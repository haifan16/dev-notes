## 概念

**栈**：线程运行需要的内存空间，一个线程一个栈
**栈帧**：每个方法运行时需要的内存（参数、局部变量、返回地址）

一个栈由多个栈帧组成，一个栈帧是一个方法

每个线程只能有一个**活动栈帧**，对应着正在执行的那个方法

## 如何判断方法内的局部变量是否线程安全？

- 如果方法内的局部变量没有逃离方法的作用范围，且是线程私有的，就是线程安全的
- 如果局部变量引用了对象，并逃离了方法的作用范围（比如将局部变量返回），就需要考虑线程安全

## 产生栈内存溢出的原因

1. 栈帧过多
2. 栈帧多大

## 线程运行诊断

### 案例1：CPU 占用过多

定位办法：

1. 用 top 命令定位哪个进程对 CPU 的占用过高

2. 用 ps 命令进一步定位是哪个线程引起的 CPU 占用过高：```ps H -eo pid,tid,%cpu | grep 进程id```

3. ```jstack 进程id```
    可以根据线程 id 找到有问题的线程，进一步定位到问题代码的源码行号

### 案例2：程序运行很长时间没有结果

死锁现象！